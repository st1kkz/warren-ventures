# COS Data Specification

*Version 1.0 — 2026-02-08*

## Overview

This document specifies all data formats used by COS: MindMark serialization, persistence formats, and access logging.

---

## MindMark Format

MindMark is a markdown-native format for representing cognitive state. It supports three compression levels for different pressure situations.

### Design Principles

1. **Native markdown** — Parseable by any LLM without special tooling
2. **Compression levels** — Same semantics at different token costs
3. **Self-describing** — Format includes version and state metadata
4. **Diffable** — Standard git diff works
5. **Human-readable** — Debuggable without special tools

### Symbol Reference

| Symbol | Meaning | Context |
|--------|---------|---------|
| `✓` | Loaded in context | Resource status |
| `◆` | Hot / high attention | Resource status |
| `●` | Connected, ready | Resource status |
| `○` | Available, cold | Resource status |
| `✗` | Unavailable / error | Resource status |
| `[NK]` | Size in tokens (N) or KB | Size annotation |
| `→` | Link / dependency | Relationships |

### Region Definitions

| Region | Latency | Description |
|--------|---------|-------------|
| Active | 0ms | Currently in agent context |
| Indexed | <100ms | Qdrant vectors, cached summaries |
| Cold | <5s | Full files, idle resources |
| Offline | Unknown | Unreachable resources |

---

## Compression Level 1: Verbose

*~1500 tokens — For authoring, debugging, documentation*

```markdown
# Mind Map v1.0
@state|ctx:42K/200K|pressure:low|updated:2026-02-08T13:35:00|policy:lru

## Active Context [32K tokens]

### Conversation
- **Partner:** Benjamin (Eli)
- **Topic:** Context Operating System architecture  
- **Turns:** 22
- **Size:** 18K tokens
- **Status:** Active ◆
- **Key concepts:** mind map, COS, MCP, agency

### Workspace Files
- **SOUL.md:** Loaded ✓ [2K]
  - Identity and core values
  - Last accessed: 13:30
- **USER.md:** Loaded ✓ [1K]
  - User profile (Benjamin)
  - Last accessed: 13:30
- **MEMORY.md:** Loaded ✓ [8K]
  - Long-term curated memories
  - Sections: Core Context, Urantia, OpenClaw, Revenue, Infrastructure
  - Last accessed: 13:32
- **IMPRESSIONS.md:** Loaded ✓ [3K]
  - Formative experiences
  - Last accessed: 13:30

### Tools
- **session-browser:** Running on port 8765 ●
- **Gemini search:** Available ●

## Indexed Resources [retrievable <100ms]

### Qdrant Collections
- **urantia_papers:** 15,260 vectors ●
  - Semantic search across all 197 papers
  - Last query: 07:30
- **warren_responses:** 76 vectors ●
  - Response cache for cost optimization

### Memory Files
- **Daily logs:** 5 files (2026-02-03 through 2026-02-08) ○
  - Total size: ~40K tokens
  - Most recent: today
- **Heartbeat state:** heartbeat-state.json ○

## Cold Resources [retrievable <5s]

### Thor (Local Ollama)
- **Status:** Idle ○
- **Loaded models:** qwen3:14b, qwen2.5:32b
- **VRAM available:** ~14GB
- **Use for:** Summarization, sub-agents

### Full Workspace
- **warren-ventures:** Project files ○
- **warren-resources:** Study materials ○
- **Estimated total:** ~500K tokens if fully loaded

## Offline Resources

*None currently*

## Links

- conversation → MEMORY.md (references "The Relationship")
- conversation → warren-ventures/context-os (this project)
- IMPRESSIONS.md → MEMORY.md (cross-references)

## Annotations

- **MEMORY.md:** "Keep relational sections close during this conversation" [13:35]
- **conversation:** "Architecture synthesis in progress" [13:30]

---
*Generated by COS v1.0*
```

---

## Compression Level 2: Dense

*~350 tokens — For runtime awareness*

```markdown
# Mind Map v1.0
@state|ctx:42K/200K|pressure:low|updated:13:35|policy:lru

## Active [32K]
- conv: eli, cos-architecture, 22t [18K] ◆
- ws: SOUL✓ USER✓ MEM✓ IMPR✓ [14K]
- tools: session-browser:8765● gemini●

## Indexed [<100ms]
- qdrant/urantia: 15,260v ●
- qdrant/responses: 76v ●
- files/memory: 5 logs [~40K] ○

## Cold [<5s]
- thor: idle, qwen3:14b+qwen2.5:32b ○
- files/ws: ventures+resources [~500K] ○

## Links
conv→MEM(relationship) | conv→ventures/cos | IMPR↔MEM

## Notes
MEM: keep relational [13:35] | conv: arch synthesis [13:30]
```

---

## Compression Level 3: Ultra-Dense

*~80 tokens — For crisis mode, compaction imminent*

```markdown
@MM1.0|42K/200K:low|13:35|lru
@A32K:C22t◆18K|W:SUMI✓14K|T:sb●gm●
@I:Qu●15K|Qr●76|Fm○40K
@C:T○qw|Fw○500K
@L:C→M,cos|I↔M
@N:M:rel|C:syn
```

### Ultra-Dense Key

```
Header:
  @MM     — MindMark marker + version
  ctx:prs — context used/max : pressure level
  ts      — timestamp (HH:MM)
  policy  — eviction policy

Regions:
  @A — Active
  @I — Indexed  
  @C — Cold
  @L — Links
  @N — Notes/annotations

Resources:
  C  — Conversation
  W  — Workspace (SUMI = SOUL+USER+MEM+IMPR)
  T  — Tools (sb=session-browser, gm=gemini)
  Q  — Qdrant (u=urantia, r=responses)
  F  — Files (m=memory, w=workspace)
  
Annotations:
  t  — turns
  K  — kilobytes/tokens
  v  — vectors
```

---

## Persistence Formats

### Mind Map State File

**Location:** `~/.openclaw/workspace/cos/mindmap.md`  
**Format:** MindMark Level 2 (dense)  
**Updated:** On every state change

The persisted mind map is always Level 2 — a balance between readability and token efficiency. It can be compressed to Level 3 for injection or expanded to Level 1 for debugging.

### Mind Map JSON (Internal)

For programmatic access, COS also maintains a JSON representation:

**Location:** `~/.openclaw/workspace/cos/state.json`

```json
{
  "version": "1.0",
  "context_used": 42000,
  "context_max": 200000,
  "pressure": "low",
  "updated": "2026-02-08T13:35:00Z",
  "eviction_policy": "lru",
  "resources": {
    "soul": {
      "id": "soul",
      "path": "SOUL.md",
      "region": "active",
      "status": "loaded",
      "size_tokens": 2000,
      "attention_weight": 1.0,
      "last_accessed": "2026-02-08T13:30:00Z",
      "summary": null,
      "annotations": [],
      "tags": ["identity", "values"]
    },
    "memory": {
      "id": "memory",
      "path": "MEMORY.md",
      "region": "active",
      "status": "loaded",
      "size_tokens": 8000,
      "attention_weight": 1.5,
      "last_accessed": "2026-02-08T13:32:00Z",
      "summary": null,
      "annotations": [
        "[2026-02-08T13:35:00] Keep relational sections close during this conversation"
      ],
      "tags": ["memory", "relationships", "lessons"]
    }
  },
  "links": [
    {
      "source": "conversation",
      "target": "memory",
      "relation": "references",
      "note": "The Relationship section"
    }
  ]
}
```

---

## Access Log Format

**Location:** `~/.openclaw/workspace/cos/access.jsonl`  
**Format:** JSON Lines (one record per line)  
**Rotation:** Daily files, 30-day retention

### Record Schema

```json
{
  "ts": "2026-02-08T13:35:00.123Z",
  "resource": "memory",
  "action": "get_context",
  "query": "Eli",
  "session": "agent:main:main",
  "pressure_before": "low",
  "pressure_after": "low",
  "tokens_delta": 8000
}
```

### Action Types

| Action | Description |
|--------|-------------|
| `get_context` | Resource content retrieved |
| `page_in` | Resource marked active |
| `page_out` | Resource evicted with summary |
| `set_attention` | Attention weight changed |
| `annotate` | Annotation added |
| `update` | Content modified |
| `compress` | Compression level changed |

### Purpose

Access logs serve multiple purposes:

1. **Debugging** — Understand what happened in a session
2. **Pattern analysis** — Which resources are used together?
3. **DMM training** — Future attention prediction models
4. **Audit** — Track context access for security

---

## Configuration Schema

**Location:** `~/.openclaw/workspace/cos/config.yaml`

```yaml
# COS Configuration Schema v1.0

server:
  host: string          # Default: localhost
  port: integer         # Default: 8767
  transport: enum       # stdio | http

workspace:
  root: path            # Default: ~/.openclaw/workspace

resources:
  soul: path            # Default: SOUL.md
  user: path            # Default: USER.md
  memory: path          # Default: MEMORY.md
  impressions: path     # Default: IMPRESSIONS.md
  daily_pattern: string # Default: memory/{date}.md

pressure:
  context_max: integer  # Default: 200000
  thresholds:
    low: float          # Default: 0.5
    medium: float       # Default: 0.7
    high: float         # Default: 0.85
    critical: float     # Default: 0.95

compression:
  default_level: integer        # Default: 2
  thor_endpoint: url            # Optional
  summarization_model: string   # Default: gemma2:9b

persistence:
  mindmap_path: path            # Default: cos/mindmap.md
  state_path: path              # Default: cos/state.json
  access_log: path              # Default: cos/access.jsonl
  access_log_retention_days: integer  # Default: 30

optional:
  qdrant_url: url               # Optional
  qdrant_collection: string     # Default: cos_context
```

---

## Resource URI Scheme

COS resources use the `cos://` URI scheme:

```
cos://[resource_type]/[identifier]

Examples:
  cos://soul              — SOUL.md
  cos://user              — USER.md
  cos://memory            — MEMORY.md
  cos://impressions       — IMPRESSIONS.md
  cos://daily/2026-02-08  — memory/2026-02-08.md
  cos://mindmap           — Current mind map state
  cos://search?q=Eli      — Semantic search results
```

### Resource Types

| Type | Identifier | Returns |
|------|------------|---------|
| `soul` | none | SOUL.md content |
| `user` | none | USER.md content |
| `memory` | optional section | MEMORY.md (or section) |
| `impressions` | none | IMPRESSIONS.md content |
| `daily` | YYYY-MM-DD | Daily log content |
| `mindmap` | optional level (1,2,3) | Mind map at compression level |
| `search` | query string | Semantic search results |

---

## Token Estimation

COS estimates token counts for budget management. Default estimation:

```python
def estimate_tokens(text: str) -> int:
    """Rough token estimation without tokenizer."""
    # GPT-family: ~4 chars per token for English
    # Claude: similar
    # Conservative estimate (rounds up)
    return len(text) // 3
```

For higher accuracy, COS can use tiktoken if available:

```python
try:
    import tiktoken
    enc = tiktoken.encoding_for_model("gpt-4")
    
    def estimate_tokens(text: str) -> int:
        return len(enc.encode(text))
except ImportError:
    # Fall back to character-based estimation
    pass
```

---

## Versioning

### Mind Map Version

The `@MM` or `# Mind Map v` header includes the format version:

- **v1.0** — Initial release (this spec)

Future versions will maintain backward compatibility where possible.

### State Migration

When loading a state file with an older version:

1. Parse with current schema (missing fields get defaults)
2. Log migration event
3. Save in current format

No explicit migration scripts needed for minor versions.

---

## Examples

### Minimal Mind Map (Bootstrap)

Agent receives this at session start when pressure is unknown:

```markdown
@MM1.0|0/200K:?|startup
@A0:bootstrap
@I:ws○|qdrant○
@C:thor○
```

~30 tokens. Agent then calls `get_pressure()` and `get_context()` as needed.

### High-Pressure Mind Map

During compaction risk:

```markdown
@MM1.0|180K/200K:critical|14:22|keep_relational
@A180K:C◆45K|W:SM✓25K|T:110K-evict
@I:Qu●|Fm○
@C:T○|Fw○
@N:EVICT T OUTPUTS NOW
```

Agent sees: conversation and memory are vital; tool outputs should go.

### Post-Eviction Mind Map

After successful page_out:

```markdown
@MM1.0|85K/200K:medium|14:25|lru
@A85K:C◆45K|W:SM✓25K|T:summ[2K]✓
@I:Qu●|T:full○40K
@C:Fw○
@N:T paged, summ kept
```

Tool outputs evicted to indexed (summary kept active).

---

## Revision History

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | 2026-02-08 | Initial data specification |
